<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>合盛辅料 -Cosun Trimmings-</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://smtpjs.com/v3/smtp.js"></script>
    <style>
        html, body { /* Ensure html also takes full height */
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Roboto', 'Open Sans', sans-serif;
            background-color: #20232A;
            color: #E0E0E0;
            display: flex;
            flex-direction: column; /* Stack children vertically */
            align-items: center;   /* Center children horizontally */
            min-height: 100vh; /* Fallback if height: 100% on html/body isn't enough */
            overflow-y: auto; /* Allow body to scroll if content overflows */
            font-size: 12pt; /* Default 'other' font size */
        }
        .container {
            background-color: #2C2F37;
            padding: 20px 10px; /* Internal padding for content */
            border-radius: 0;
            box-shadow: none;
            width: 100%; /* Full width */
            max-width: 600px; /* Max width for larger screens */
            border: none;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
            display: flex; /* Make container a flexbox for its children */
            flex-direction: column; /* Stack container's children vertically */
            flex-grow: 1; /* Allow container to grow to fill available vertical space in body */
        }
        h1 {
            color: #FFFFFF;
            text-align: center;
            margin-bottom: 25px;
            font-size: 20pt; /* Header font size */
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            line-height: 1.2;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        td, th {
            padding: 5px 12px; /* Reduced top/bottom padding */
            border: 1px solid #3B3E45;
            text-align: left; /* Explicitly set to left */
            vertical-align: middle; /* Added vertical centering */
            font-size: 12pt; /* Other font size */
            font-family: 'Open Sans', sans-serif;
            line-height: 1.4; /* Adjust line height for two lines */
        }
        th {
            background-color: #3B3E45;
            color: #E0E0E0;
            font-weight: 600;
            font-family: 'Roboto', sans-serif;
        }
        label {
            font-weight: 500;
            color: #C0C0C0;
            display: block;
            margin-bottom: 5px;
            font-family: 'Open Sans', sans-serif;
            font-size: 12pt; /* Other font size */
        }
        input[type="number"],
        input[type="text"],
        select {
            width: calc(100% - 20px);
            padding: 8px; /* Slightly reduced padding */
            border: 1px solid #4A4D54;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 12pt; /* Other font size */
            background-color: #3B3E45;
            color: #E0E0E0;
            transition: border-color 0.3s;
            margin-bottom: 5px; /* Slightly reduced margin */
            font-family: 'Open Sans', sans-serif;
        }
        tr td > select:last-child,
        tr td > input[type="number"]:last-child,
        tr td > input[type="text"]:last-child {
            margin-bottom: 0;
        }
        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            border-color: #00A2FF;
            outline: none;
        }
        button {
            background: #00A2FF;
            color: white;
            padding: 12px 18px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12pt; /* Other font size */
            font-weight: 600;
            transition: background 0.3s ease;
            display: block;
            width: auto;
            min-width: 180px;
            margin: 20px auto 12px auto;
            font-family: 'Roboto', sans-serif;
        }
        button:hover {
            background: #0080ed;
        }
        #downloadButton {
            background: #00A2FF;
            border-radius: 20px;
        }
        #downloadButton:hover {
            background: #0080ed;
        }
        #result {
            margin-top: 25px;
            padding: 0;
            border: none;
            border-radius: 0;
            background-color: #2C2F37;
            line-height: 1.6;
            display: none;
            /* Allow result section to grow if needed, but not shrink items */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        #result.has-content {
            padding: 15px 8px;
            border: 1px solid #3B3E45;
            display: flex; /* Use flex to manage inner content */
            color: #00A2FF; /* Default color for result content, can be overridden */
        }
        #result .result-header .company-title {
            display: block;
            text-align: center;
            font-size: 20pt; /* Header font size */
            color: #FFFFFF;
            margin-bottom: 5px;
            font-family: 'Roboto', sans-serif;
            line-height: 1.2; /* Adjust line height for two lines */
        }
        #result .result-header .customer-info {
            display: block;
            text-align: center;
            font-size: 12pt; /* Other font size */
            font-weight: normal;
            color: #A0A0A0;
            margin-bottom: 3px;
            font-family: 'Open Sans', sans-serif;
        }
        #result .result-header .date-quote {
            display: block;
            text-align: center;
            font-size: 12pt; /* Other font size */
            font-weight: normal;
            color: #A0A0A0;
            margin-bottom: 12px;
            font-family: 'Open Sans', sans-serif;
        }
        #result table {
            margin-top: 8px;
            flex-shrink: 0; /* Prevent table from shrinking if content is too much */
        }
        #result table td,
        #result table th {
            border: 1px solid #4A4D54;
            font-size: 12pt; /* Ensure table text in result is also 12pt */
            line-height: 1.4; /* Default line-height for table cells */
        }
        #result table td.multi-line-left,
        #result table td.multi-line-right {
             line-height: 1.4; /* Specific line-height for multi-line cells */
        }
        #result table th {
            background-color: #3B3E45;
            color: #E0E0E0;
            font-family: 'Roboto', sans-serif;
            line-height: 1.3; /* Adjust line height for header two lines */
        }
        #result table td[colspan="2"][style*="text-align:center"] {
            background-color: #33363E;
            font-weight: bold;
            color: #E0E0E0;
            font-family: 'Roboto', sans-serif;
            text-align: center !important; /* Ensure center alignment override */
            line-height: 1.3; /* Adjust line height for two lines */
        }
        #result .total td strong {
            color: #00FF00;
            font-family: 'Roboto', sans-serif;
        }
        #result .total td:first-child {
            color: #00FF00;
            font-family: 'Roboto', sans-serif;
             line-height: 1.4; /* Ensure consistent line-height */
        }
         #result .total td:last-child {
             line-height: 1.4; /* Ensure consistent line-height */
        }
        #result .note {
            font-size: 12pt; /* Other font size */
            color: #A0A0A0;
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px dashed #4A4D54;
            line-height: 1.5;
            font-family: 'Open Sans', sans-serif;
            flex-shrink: 0; /* Prevent note from shrinking */
        }
        .tip {
            font-size: 12pt; /* Other font size */
            color: #888B92;
            display: block;
            margin-top: 3px;
            font-family: 'Open Sans', sans-serif;
        }
        @media (max-width: 480px) {
            .container {
                /* width: 100%; Ensure it takes full width on small screens */
                padding: 15px 8px; /* Adjust padding for smaller screens */
            }
            td, th {
                padding: 4px 10px; 
            }
            input[type="number"],
            input[type="text"],
            select {
                padding: 8px;
            }
            button {
                padding: 10px 16px;
                min-width: 160px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>客户专享<br><span style="font-size: 0.7em; color: #B0B0B0;">Exclusive for Clients</span></h1>
        <table>
            <tbody>
            <tr>
                <td><label for="customerName">客户名称：</label></td>
                <td>
                    <input type="text" id="customerName" required="">
                </td>
            </tr>
            <tr>
                <td><label for="contactInfo">联系方式：</label></td>
                <td>
                    <input type="text" id="contactInfo" required="">
                </td>
            </tr>
            <tr>
                <td><label for="orderCategory">订单类型：</label></td>
                <td>
                    <select id="orderCategory" required="">
                        <option value="">请选择订单类型</option>
                        <option value="样品订单">样品订单</option>
                        <option value="量产订单">量产订单</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><label for="type">钮扣类型：</label></td>
                <td>
                    <select id="type" required="" onchange="updateAvailableThicknesses()">
                        <option value="">请选择类型</option>
                        <option value="磁钮">磁钮</option>
                        <option value="月光">月光</option>
                        <option value="珠光">珠光</option>
                        <option value="混色散花">混色散花</option>
                        <option value="彩虹钮">彩虹钮</option>
                        <option value="棍花钮">棍花钮</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><label for="sizeType">制作工艺：</label></td>
                <td>
                    <select id="sizeType" required="" onchange="toggleButtonSizeInputs()">
                        <option value="">请选择制作工艺</option>
                        <option value="tube">棍花 (Stick Pattern)</option>
                        <option value="punch">片桶 (Sheet Barrel)</option>
                    </select>
                </td>
            </tr>
            <tr id="tubeSizeRow" style="display: none;">
                <td><label for="tubeButtonSize">棍花尺寸：</label></td>
                <td>
                    <select id="tubeButtonSize" onchange="updateAvailableThicknesses()" disabled=""><option value="">请选择棍花尺寸</option></select>
                </td>
            </tr>
            <tr id="punchSizeRow" style="display: none;">
                <td><label for="punchButtonSize">片桶尺寸：</label></td>
                <td>
                    <select id="punchButtonSize" onchange="updateAvailableThicknesses()"><option value="">请选择片桶尺寸</option></select>
                </td>
            </tr>
            <tr>
                <td><label for="quantity">订单数量（G）：</label></td>
                <td>
                    <input type="number" id="quantity" min="1" value="100" required="">
                </td>
            </tr>
            <tr>
                <td><label for="thickness">成品厚度（mm）：</label></td>
                <td>
                    <select id="thickness" required=""><option value="">请选择厚度</option></select>
                </td>
            </tr>
            <tr>
                <td><label for="laserOption">镭射选项：</label></td>
                <td>
                    <select id="laserOption">
                        <option value="none">不需要镭射</option>
                        <option value="surfaceLetter">射面字母</option>
                        <option value="sideEdge">侧边镭射</option>
                    </select>
                    <span class="tip">镭射精工，铸就非凡细节</span>
                </td>
            </tr>
            <tr>
                <td><label for="obliqueOption">斜车选项：</label></td>
                <td>
                    <select id="obliqueOption">
                        <option value="no">不需要斜车</option>
                        <option value="yes">需要斜车</option>
                    </select>
                    <span class="tip">斜车工艺可提升钮扣质感</span>
                </td>
            </tr>
            <tr>
                <td><label for="oilOption">泡油选项：</label></td>
                <td>
                    <select id="oilOption">
                        <option value="no">不需要泡油</option>
                        <option value="yes">需要泡油</option>
                    </select>
                    <span class="tip">泡油增强光泽，成本增5%</span>
                </td>
            </tr>
        </tbody></table>
        <button onclick="calculatePrice()">计算总价 (Calculate Total Price)</button>
        <div id="result"></div>
    </div>
    <script>
        const buttonData = {
            "12L": { standardThickness: 2.4, types: { "磁钮": 2.75, "月光": 2.97, "珠光": 2.97, "混色散花": 3.52, "彩虹钮": 4.40, "棍花钮": 3.74 }, obliquePriceRatio: 1.3, laserSurfaceLetter: 0.90, laserSideEdge: 3.50 },
            "13L": { standardThickness: 2.4, types: { "磁钮": 2.75, "月光": 2.97, "珠光": 2.97, "混色散花": 3.52, "彩虹钮": 4.40, "棍花钮": 3.74 }, obliquePriceRatio: 1.3, laserSurfaceLetter: 0.90, laserSideEdge: 3.50 },
            "14L": { standardThickness: 2.4, types: { "磁钮": 2.75, "月光": 2.97, "珠光": 2.97, "混色散花": 3.52, "彩虹钮": 4.40, "棍花钮": 3.74 }, obliquePriceRatio: 1.3, laserSurfaceLetter: 0.90, laserSideEdge: 3.50 },
            "15L": { standardThickness: 2.4, types: { "磁钮": 2.75, "月光": 2.97, "珠光": 2.97, "混色散花": 3.52, "彩虹钮": 4.40, "棍花钮": 3.74 }, obliquePriceRatio: 1.3, laserSurfaceLetter: 0.90, laserSideEdge: 3.50 },
            "16L": { standardThickness: 2.4, types: { "磁钮": 2.75, "月光": 2.97, "珠光": 2.97, "混色散花": 3.52, "彩虹钮": 4.40, "棍花钮": 3.74 }, obliquePriceRatio: 1.3, laserSurfaceLetter: 0.90, laserSideEdge: 3.50 },
            "17L": { standardThickness: 2.4, types: { "磁钮": 2.75, "月光": 2.97, "珠光": 2.97, "混色散花": 3.52, "彩虹钮": 4.40, "棍花钮": 3.74 }, obliquePriceRatio: 1.3, laserSurfaceLetter: 0.90, laserSideEdge: 3.50 },
            "18L": { standardThickness: 2.4, types: { "磁钮": 2.75, "月光": 2.97, "珠光": 2.97, "混色散花": 3.52, "彩虹钮": 4.40, "棍花钮": 3.74 }, obliquePriceRatio: 1.3, laserSurfaceLetter: 0.90, laserSideEdge: 3.50 },
            "19L": { standardThickness: 2.6, types: { "磁钮": 3.30, "月光": 3.52, "珠光": 3.52, "混色散花": 4.18, "彩虹钮": 6.05, "棍花钮": 4.51 }, obliquePriceRatio: 1.3, laserSurfaceLetter: 1.00, laserSideEdge: 3.50 },
            "20L": { standardThickness: 2.6, types: { "磁钮": 3.30, "月光": 3.52, "珠光": 3.52, "混色散花": 4.18, "彩虹钮": 6.05, "棍花钮": 4.51 }, obliquePriceRatio: 1.3, laserSurfaceLetter: 1.00, laserSideEdge: 3.50 },
            "22L": { standardThickness: 2.8, types: { "磁钮": 4.40, "月光": 4.84, "珠光": 4.95, "混色散花": 4.95, "彩虹钮": 7.48, "棍花钮": 5.50 }, obliquePriceRatio: 1.3, laserSurfaceLetter: 1.20, laserSideEdge: 3.50 },
            "24L": { standardThickness: 3.0, types: { "磁钮": 5.06, "月光": 5.50, "珠光": 5.72, "混色散花": 5.72, "彩虹钮": 8.25, "棍花钮": 6.49 }, obliquePriceRatio: 1.3, laserSurfaceLetter: 1.50, laserSideEdge: 4.00 },
            "26L": { standardThickness: 3.1, types: { "磁钮": 5.83, "月光": 6.38, "珠光": 7.48, "混色散花": 7.48, "彩虹钮": 9.35, "棍花钮": 8.03 }, obliquePriceRatio: 1.3, laserSurfaceLetter: 1.80, laserSideEdge: 4.00 },
            "27L": { standardThickness: 3.1, types: { "磁钮": 6.60, "月光": 9.90, "珠光": 10.95, "混色散花": 10.45, "彩虹钮": 9.02, "棍花钮": 9.02 }, obliquePriceRatio: 1.3, laserSurfaceLetter: 2.00, laserSideEdge: 4.00 },
            "28L": { standardThickness: 3.2, types: { "磁钮": 7.48, "月光": 8.25, "珠光": 9.13, "混色散花": 9.13, "彩虹钮": 12.10, "棍花钮": 10.01}, obliquePriceRatio: 1.4, laserSurfaceLetter: 2.20, laserSideEdge: 4.50 },
            "30L": { standardThickness: 3.3, types: { "磁钮": 8.25, "月光": 9.02, "珠光": 10.45, "混色散花": 10.45, "彩虹钮": 13.20, "棍花钮": 11.00}, obliquePriceRatio: 1.4, laserSurfaceLetter: 2.80, laserSideEdge: 4.50 },
            "32L": { standardThickness: 3.5, types: { "磁钮": 9.35, "月光": 10.45, "珠光": 11.88, "混色散花": 11.88, "彩虹钮": 15.60, "棍花钮": 13.20}, obliquePriceRatio: 1.4, laserSurfaceLetter: 3.20, laserSideEdge: 5.00 },
            "34L": { standardThickness: 3.6, types: { "磁钮": 11.55,"月光": 12.65, "珠光": 13.75, "混色散花": 13.75, "彩虹钮": 17.25, "棍花钮": 16.50}, obliquePriceRatio: 1.4, laserSurfaceLetter: 4.00, laserSideEdge: 5.00 },
            "36L": { standardThickness: 3.8, types: { "磁钮": 13.20,"月光": 14.30, "珠光": 15.95, "混色散花": 15.95, "彩虹钮": 24.20, "棍花钮": 17.60}, obliquePriceRatio: 1.4, laserSurfaceLetter: 4.20, laserSideEdge: 6.50 },
            "38L": { standardThickness: 4.0, types: { "磁钮": 18.15,"月光": 19.80, "珠光": 20.90, "混色散花": 20.90, "彩虹钮": 33.00, "棍花钮": 20.90}, obliquePriceRatio: 1.5, laserSurfaceLetter: 4.50, laserSideEdge: 9.00 },
            "40L": { standardThickness: 4.2, types: { "磁钮": 19.80,"月光": 21.45, "珠光": 22.00, "混色散花": 22.00, "彩虹钮": 35.20, "棍花钮": 22.11}, obliquePriceRatio: 1.5, laserSurfaceLetter: 6.00, laserSideEdge: 9.00 },
            "42L": { standardThickness: 4.2, types: { "磁钮": 22.00,"月光": 25.30, "珠光": 26.40, "混色散花": 26.40, "彩虹钮": 44.00, "棍花钮": 28.60}, obliquePriceRatio: 1.5, laserSurfaceLetter: 6.50, laserSideEdge: 9.00 },
            "44L": { standardThickness: 4.5, types: { "磁钮": 26.40,"月光": 28.60, "珠光": 30.80, "混色散花": 30.80, "彩虹钮": 50.60, "棍花钮": 35.20}, obliquePriceRatio: 1.5, laserSurfaceLetter: 7.00, laserSideEdge: 10.50 },
            "46L": { standardThickness: 4.5, types: { "磁钮": 26.40,"月光": 28.60, "珠光": 30.80, "混色散花": 30.80, "彩虹钮": 50.60, "棍花钮": 35.20}, obliquePriceRatio: 1.5, laserSurfaceLetter: 7.00, laserSideEdge: 10.50 },
            "48L": { standardThickness: 4.8, types: { "磁钮": 30.80,"月光": 33.00, "珠光": 36.30, "混色散花": 36.30, "彩虹钮": 56.10, "棍花钮": 41.80}, obliquePriceRatio: 1.8, laserSurfaceLetter: 8.50, laserSideEdge: 14.00 },
            "50L": { standardThickness: 4.8, types: { "磁钮": 39.60,"月光": 44.00, "珠光": 44.00, "混色散花": 44.00, "彩虹钮": 60.50, "棍花钮": 50.60}, obliquePriceRatio: 1.8, laserSurfaceLetter: 10.00, laserSideEdge: 22.00 },
            "54L": { standardThickness: 5.4, types: { "磁钮": 49.50,"月光": 55.00, "珠光": 55.00, "混色散花": 55.00, "彩虹钮": 68.20, "棍花钮": 61.60}, obliquePriceRatio: 1.8, laserSurfaceLetter: 14.00, laserSideEdge: 28.00 },
            "60L": { standardThickness: 5.4, types: { "磁钮": 49.50,"月光": 55.00, "珠光": 55.00, "混色散花": 55.00, "彩虹钮": 68.20, "棍花钮": 61.60}, obliquePriceRatio: 1.8, laserSurfaceLetter: 14.00, laserSideEdge: 28.00 },
            "64L": { standardThickness: 5.4, types: { "磁钮": 49.50,"月光": 55.00, "珠光": 55.00, "混色散花": 55.00, "彩虹钮": 68.20, "棍花钮": 61.60}, obliquePriceRatio: 1.8, laserSurfaceLetter: 14.00, laserSideEdge: 28.00 },
            "70L": { standardThickness: 5.4, types: { "磁钮": 49.50,"月光": 55.00, "珠光": 55.00, "混色散花": 55.00, "彩虹钮": 68.20, "棍花钮": 61.60}, obliquePriceRatio: 1.8, laserSurfaceLetter: 14.00, laserSideEdge: 28.00 }
        };
        const thicknessOptionsDefault = [1.0, 1.5, 2.0, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 3.0, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9, 4.0, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8, 4.9, 5.0, 5.1, 5.2, 5.3, 5.4, 5.5, 6.0];
        const combinedLSizes = ["12L", "13L", "14L", "15L", "16L", "17L", "18L", "19L", "20L", "22L", "24L", "26L", "27L", "28L", "30L", "32L", "34L", "36L", "38L", "40L", "42L", "44L", "46L", "48L", "50L", "54L", "60L", "64L", "70L"];

        function populateLSizeOptions(selectElement, lValues, placeholderText) {
            selectElement.innerHTML = `<option value="">${placeholderText}</option>`;
            lValues.forEach(lVal => {
                const option = document.createElement('option');
                option.value = lVal;
                option.textContent = lVal;
                selectElement.appendChild(option);
            });
        }

        function toggleButtonSizeInputs() {
            const sizeType = document.getElementById('sizeType').value;
            const tubeSizeRow = document.getElementById('tubeSizeRow');
            const punchSizeRow = document.getElementById('punchSizeRow');
            const tubeButtonSizeSelect = document.getElementById('tubeButtonSize');
            const punchButtonSizeSelect = document.getElementById('punchButtonSize');
            if (sizeType === 'tube') {
                tubeSizeRow.style.display = ''; punchSizeRow.style.display = 'none';
                tubeButtonSizeSelect.disabled = false; punchButtonSizeSelect.disabled = true;
                punchButtonSizeSelect.value = '';
            } else if (sizeType === 'punch') {
                tubeSizeRow.style.display = 'none'; punchSizeRow.style.display = '';
                tubeButtonSizeSelect.disabled = true; punchButtonSizeSelect.disabled = false;
                tubeButtonSizeSelect.value = '';
            } else {
                tubeSizeRow.style.display = 'none'; punchSizeRow.style.display = 'none';
                tubeButtonSizeSelect.disabled = true; punchButtonSizeSelect.disabled = true;
                tubeButtonSizeSelect.value = ''; punchButtonSizeSelect.value = '';
            }
            updateAvailableThicknesses();
        }

        function getActiveButtonSize() {
            const sizeType = document.getElementById('sizeType').value;
            if (sizeType === 'tube') return document.getElementById('tubeButtonSize').value;
            if (sizeType === 'punch') return document.getElementById('punchButtonSize').value;
            return null;
        }

        function updateAvailableThicknesses() {
            const selectedLSize = getActiveButtonSize();
            const thicknessSelect = document.getElementById('thickness');
            thicknessSelect.innerHTML = '<option value="">请选择厚度</option>';
            let standardThicknessForSize = null;
            if (selectedLSize && buttonData[selectedLSize]) {
                standardThicknessForSize = buttonData[selectedLSize].standardThickness;
                const availableThicknesses = thicknessOptionsDefault.filter(thick => thick >= standardThicknessForSize);
                availableThicknesses.forEach(thickVal => {
                    const option = document.createElement('option');
                    option.value = thickVal.toFixed(1);
                    option.textContent = thickVal.toFixed(1) + ' mm' + (thickVal === standardThicknessForSize ? ' (标准)' : '');
                    thicknessSelect.appendChild(option);
                });
                if (standardThicknessForSize) {
                    thicknessSelect.value = standardThicknessForSize.toFixed(1);
                }
            }
        }

        function formatNumber(num, decimals = 2) {
            if (isNaN(parseFloat(num))) return 'N/A';
            return parseFloat(num).toFixed(decimals);
        }

        function getCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            return `${year}年${month}月${day}日`;
        }

        function calculatePrice() {
            const customerName = document.getElementById('customerName').value;
            const contactInfo = document.getElementById('contactInfo').value;
            const orderCategory = document.getElementById('orderCategory').value;
            const sizeType = document.getElementById('sizeType').value;
            const buttonLSize = getActiveButtonSize();
            const type = document.getElementById('type').value;
            const quantity = parseFloat(document.getElementById('quantity').value);
            const thickness = parseFloat(document.getElementById('thickness').value);
            const laserOption = document.getElementById('laserOption').value;
            const obliqueOption = document.getElementById('obliqueOption').value;
            const oilOption = document.getElementById('oilOption').value;
            const resultDiv = document.getElementById('result');
            resultDiv.className = ''; // Reset class
            resultDiv.style.display = 'none'; // Hide first

            if (!customerName || !contactInfo || !orderCategory || !sizeType || !buttonLSize || !type || isNaN(quantity) || quantity <= 0 || isNaN(thickness) || thickness <= 0) {
                resultDiv.innerHTML = '请填写所有必填项（客户名称、联系方式、订单类型、钮扣类型、制作工艺、钮扣尺寸、订单数量、厚度），并确保订单数量和厚度为有效正数。';
                resultDiv.style.color = '#e74c3c';
                resultDiv.className = 'has-content'; // Add class to make it visible and styled
                resultDiv.style.display = 'flex'; // Ensure it's flex for inner content when error shows
                return;
            }

            const data = buttonData[buttonLSize];
            if (!data || !data.types[type]) {
                resultDiv.innerHTML = `选择的钮扣尺寸 (${buttonLSize}) 或类型 (${type}) 数据不存在，请检查。`;
                resultDiv.style.color = '#e74c3c'; // Keep error color consistent
                resultDiv.className = 'has-content'; 
                resultDiv.style.display = 'flex'; return;
            }

            let basePrice = data.types[type];
            const originalBasePrice = basePrice;
            let thicknessAdjustedPrice = basePrice;
            if (data.standardThickness && thickness !== data.standardThickness) {
                thicknessAdjustedPrice = (thickness * basePrice / data.standardThickness);
            }

            let obliqueCostPerG = 0; let priceAfterOblique = thicknessAdjustedPrice;
            if (obliqueOption === 'yes' && data.obliquePriceRatio) {
                obliqueCostPerG = thicknessAdjustedPrice * (data.obliquePriceRatio - 1);
                priceAfterOblique = thicknessAdjustedPrice * data.obliquePriceRatio;
            }

            let laserCostPerG = 0;
            if (laserOption === 'surfaceLetter' && data.laserSurfaceLetter !== undefined) laserCostPerG = data.laserSurfaceLetter;
            else if (laserOption === 'sideEdge' && data.laserSideEdge !== undefined) laserCostPerG = data.laserSideEdge;

            let unitPriceBeforeOil = priceAfterOblique + laserCostPerG;
            let oilCostPerG = 0; let finalUnitPrice = unitPriceBeforeOil;
            if (oilOption === 'yes') {
                oilCostPerG = unitPriceBeforeOil * 0.05;
                finalUnitPrice = unitPriceBeforeOil * 1.05;
            }

            const totalBaseCostAfterAdj = thicknessAdjustedPrice * quantity;
            const totalObliqueCost = obliqueCostPerG * quantity;
            const totalLaserCost = laserCostPerG * quantity;
            const totalOilCost = oilCostPerG * quantity;
            const totalPrice = finalUnitPrice * quantity;

            const sizeTypeLabel = sizeType === 'tube' ? '棍花' : '片桶';
            const displayButtonSize = buttonLSize;
            const selectedButtonSizeRow = `<tr><td class="multi-line-left">${sizeTypeLabel}尺寸<br>Size</td><td>${displayButtonSize}</td></tr>`;

            const orderCategoryDisplay = orderCategory;
            
            const laserOptionDisplay = laserOption === 'none' ? '不需要镭射<br>None' : (laserOption === 'surfaceLetter' ? '射面字母<br>Surface Lettering' : '侧边镭射<br>Side Edge');
            const obliqueOptionDisplay = obliqueOption === 'no' ? '不需要斜车<br>No' : '需要斜车<br>Yes';
            const oilOptionDisplay = oilOption === 'no' ? '不需要泡油<br>No' : '需要泡油<br>Yes';

            resultDiv.innerHTML = `
                <div style="width:100%;"> <div class="result-header">
                        <strong class="company-title">合盛辅料<br>-Cosun Trimmings-</strong>
                        <strong class="customer-info">客户: ${customerName} | 联系方式: ${contactInfo}</strong>
                        <strong class="date-quote">${getCurrentDate()}当日报价 (Today's Quote)</strong>
                    </div>
                    <table>
                        <tr><th colspan="2" style="text-align:center;">参数信息<br>Parameter Information</th></tr>
                        <tr><td class="multi-line-left">订单类型<br>Order Category</td><td>${orderCategoryDisplay}</td></tr>
                        <tr><td class="multi-line-left">钮扣类型<br>Button Type</td><td>${type}</td></tr>
                        <tr><td class="multi-line-left">制作工艺<br>Manufacturing Process</td><td>${sizeTypeLabel}</td></tr>
                        ${selectedButtonSizeRow}
                        <tr><td class="multi-line-left">订单数量<br>Order Quantity</td><td>${formatNumber(quantity, 0)}G</td></tr>
                        <tr><td class="multi-line-left">成品厚度<br>Finished Thickness</td><td>${formatNumber(thickness,1)} mm</td></tr>
                        <tr><td class="multi-line-left">镭射选项<br>Laser Option</td><td>${laserOptionDisplay.replace(/<br>.*/, '')}</td></tr>
                        <tr><td class="multi-line-left">斜车选项<br>Oblique Option</td><td>${obliqueOptionDisplay.replace(/<br>.*/, '')}</td></tr>
                        <tr><td class="multi-line-left">泡油选项<br>Oil Option</td><td>${oilOptionDisplay.replace(/<br>.*/, '')}</td></tr>

                        <tr><td colspan="2" style="text-align:center; font-weight:bold;">单价构成<br>Unit Price Breakdown</td></tr>
                        <tr><td class="multi-line-left">基础单价<br>Base Unit Price</td><td class="multi-line-right">${formatNumber(originalBasePrice)} 元/G<br>${type}</td></tr>
                        <tr>
                            <td class="multi-line-left">厚度调整单价<br>Thickness Adj. Price</td>
                            <td class="multi-line-right">${formatNumber(thicknessAdjustedPrice)} 元/G<br>${data.standardThickness ? data.standardThickness.toFixed(1) : 'N/A'}mm 标准</td>
                        </tr>
                        <tr>
                            <td class="multi-line-left">斜车成本/单价<br>Oblique Cost/Unit</td>
                            <td class="multi-line-right">${obliqueOption === 'yes' && data.obliquePriceRatio ? `${formatNumber(obliqueCostPerG)} 元/G<br>Ratio: ${((data.obliquePriceRatio - 1) * 100).toFixed(0)}%` : '无<br>None'}</td>
                        </tr>
                        <tr>
                            <td class="multi-line-left">镭射成本/单价<br>Laser Cost/Unit</td>
                            <td class="multi-line-right">${laserOption !== 'none' && laserCostPerG > 0 ? `${formatNumber(laserCostPerG)} 元/G<br>${laserOption === 'surfaceLetter' ? '射面字母' : '侧边镭射'}` : '无<br>None'}</td>
                        </tr>
                        <tr>
                            <td class="multi-line-left">泡油成本/单价<br>Oil Cost/Unit</td>
                            <td class="multi-line-right">${oilOption === 'yes' ? `${formatNumber(oilCostPerG)} 元/G<br>增5%` : '无<br>None'}</td>
                        </tr>
                        <tr><td class="multi-line-left"><strong>合计单价<br>Total Unit Price</strong></td><td><strong>${formatNumber(finalUnitPrice)} 元/G</strong></td></tr>
                        
                        <tr><td colspan="2" style="text-align:center; font-weight:bold;">费用明细<br>Itemized Costs</td></tr>
                        <tr><td class="multi-line-left">基础总费用<br>Total Base Cost</td><td>${formatNumber(totalBaseCostAfterAdj)} 元</td></tr>
                        <tr><td class="multi-line-left">总斜车费<br>Total Oblique Cost</td><td>${formatNumber(totalObliqueCost)} 元</td></tr>
                        <tr><td class="multi-line-left">总镭射费<br>Total Laser Cost</td><td>${formatNumber(totalLaserCost)} 元</td></tr>
                        <tr><td class="multi-line-left">总泡油费<br>Total Oil Cost</td><td>${formatNumber(totalOilCost)} 元</td></tr>
                        <tr class="total"><td class="multi-line-left"><strong>总价<br>Total Price</strong></td><td><strong>${formatNumber(totalPrice)} 元</strong></td></tr>
                    </table>
                    <div class="note">
                        尊敬的客户：<br>
                        您好！感谢您对我们的关注与支持。在此温馨提示，线上所展示价格明细均为合盛知识库首次为您估算，仅供参考，如有任何疑问或需要进一步确认具体报价，请与您专属销售顾问联系。感谢您的理解与配合！祝商祺！
                        <br><br>
                        Dear Customer,<br>
                        Hello! Thank you for your attention and support. We would like to kindly remind you that the price details displayed online are initial estimates provided by the Hesheng Knowledge Base for your reference only. If you have any questions or need to further confirm specific quotations, please contact your dedicated sales consultant. Thank you for your understanding and cooperation! Best regards!
                    </div>
                    <button id="downloadButton" onclick="downloadResultImage()">下载图片 (Download Image)</button>
                </div>
            `;
            resultDiv.className = 'has-content'; // Add class to make it visible and styled
            resultDiv.style.display = 'flex'; // Ensure it uses flex for inner content
        }

        function downloadResultImage() {
            const resultDivForImage = document.getElementById('result');
            // Temporarily use a clone of the result div for image generation to avoid display flashes
            const clone = resultDivForImage.cloneNode(true);
            clone.style.position = 'absolute';
            clone.style.left = '-9999px'; // Move off-screen
            clone.style.top = '-9999px';
            clone.style.width = resultDivForImage.offsetWidth + 'px'; // Ensure width is maintained
            document.body.appendChild(clone);

            const downloadBtnOriginal = resultDivForImage.querySelector('#downloadButton');
            const downloadBtnClone = clone.querySelector('#downloadButton');
            if(downloadBtnClone) downloadBtnClone.style.display = 'none';


            html2canvas(clone, { // Use the clone for canvas generation
                backgroundColor: '#2C2F37',
                scale: 2.5,
                useCORS: true,
                logging: false,
                onclone: function (clonedDoc) {
                    const clonedResultDiv = clonedDoc.getElementById('result'); // This ID will be on the clone
                    if (clonedResultDiv) {
                        clonedResultDiv.style.color = '#FFFFFF'; 
                        clonedResultDiv.style.padding = '15px 8px 15px 8px';

                        const companyTitle = clonedResultDiv.querySelector('.company-title');
                        if(companyTitle) companyTitle.style.color = '#FFFFFF';

                        const customerInfo = clonedResultDiv.querySelector('.customer-info');
                        if(customerInfo) customerInfo.style.color = '#A0A0A0';

                        const dateQuote = clonedResultDiv.querySelector('.date-quote');
                        if(dateQuote) dateQuote.style.color = '#A0A0A0';

                        clonedResultDiv.querySelectorAll('table th').forEach(el => el.style.color = '#E0E0E0');
                        const sectionTitles = clonedResultDiv.querySelectorAll('table td[colspan="2"][style*="text-align:center"]');
                        sectionTitles.forEach(el => {
                            el.style.color = '#FFFFFF'; 
                        });
                        const totalLabel = clonedResultDiv.querySelector('.total td:first-child');
                        if(totalLabel) totalLabel.style.color = '#00FF00';
                        const totalValue = clonedResultDiv.querySelector('.total td strong');
                        if(totalValue) totalValue.style.color = '#00FF00';
                        const note = clonedResultDiv.querySelector('.note');
                        if(note) note.style.color = '#A0A0A0';
                        clonedResultDiv.className = 'has-content';
                        clonedResultDiv.style.display = 'flex'; // Keep flex for layout
                        clonedResultDiv.style.flexDirection = 'column';
                        clonedResultDiv.style.borderRadius = '0';
                        clonedResultDiv.querySelectorAll('table td, table th').forEach(cell => {
                            cell.style.lineHeight = '1.4'; 
                        });
                        clonedResultDiv.querySelectorAll('table th, table td[colspan="2"][style*="text-align:center"]').forEach(headerCell => {
                             headerCell.style.lineHeight = '1.3'; 
                        });
                    }
                }
            }).then(canvas => {
                const paddingPx = 35 * 2.5;
                const paddedCanvas = document.createElement('canvas');
                paddedCanvas.width = canvas.width;
                paddedCanvas.height = canvas.height + 2 * paddingPx;
                const ctx = paddedCanvas.getContext('2d');
                ctx.fillStyle = '#2C2F37';
                ctx.fillRect(0, 0, paddedCanvas.width, paddedCanvas.height);
                ctx.drawImage(canvas, 0, paddingPx);

                const watermarkText = '合盛辅料';
                const fontSize = Math.max(6, Math.min(paddedCanvas.width / 70, paddedCanvas.height / 45) * 0.8);
                ctx.font = `normal ${fontSize}px Roboto`;
                ctx.fillStyle = 'rgba(128, 128, 128, 0.12)';
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                const angle = -Math.PI / 4;
                const textMetrics = ctx.measureText(watermarkText);
                const textWidth = textMetrics.width;
                const xSpacing = textWidth * 2.5;
                const ySpacing = fontSize * 6.0;
                ctx.save();
                for (let y = -paddedCanvas.height * 0.25; y < paddedCanvas.height * 1.25; y += ySpacing) {
                    for (let x = -paddedCanvas.width * 0.25; x < paddedCanvas.width * 1.25; x += xSpacing) {
                        ctx.save();
                        ctx.translate(x + ((Math.floor(y / ySpacing)) % 2 === 0 ? 0 : xSpacing / 2), y);
                        ctx.rotate(angle);
                        ctx.fillText(watermarkText, 0, 0);
                        ctx.restore();
                    }
                }
                ctx.restore();

                const fileName = "合作共赢.静候佳音.jpg";

                const link = document.createElement('a');
                link.download = fileName;
                const imageDataUrl = paddedCanvas.toDataURL('image/jpeg', 0.9);
                link.href = imageDataUrl;
                link.click();
                document.body.removeChild(clone); // Remove the clone after use
                // No need to restore downloadBtnOriginal display as it was never hidden
            }).catch(error => {
                console.error('Image generation failed:', error);
                alert('图片生成失败，请重试或检查浏览器控制台获取错误信息。');
                document.body.removeChild(clone); // Remove the clone on error too
            });
        }

        window.onload = function () {
            const resultDiv = document.getElementById('result');
            if (resultDiv) {
                resultDiv.style.display = 'none';
                resultDiv.className = ''; // Reset class
            }
            const tubeButtonSizeSelect = document.getElementById('tubeButtonSize');
            const punchButtonSizeSelect = document.getElementById('punchButtonSize');
            populateLSizeOptions(tubeButtonSizeSelect, combinedLSizes, '请选择棍花尺寸');
            populateLSizeOptions(punchButtonSizeSelect, combinedLSizes, '请选择片桶尺寸');
            toggleButtonSizeInputs();
            updateAvailableThicknesses();
            document.getElementById('type').addEventListener('change', updateAvailableThicknesses);
        };
    </script>
</body>
</html>